#!/usr/bin/python3.6

import sys
import os
import time

import MySQLdb
from loguru import logger

from utils import http_get


def get_app_list():
    db = MySQLdb.connect("127.0.0.1", "root", "123456", "zztest", charset='utf8' )
    cursor = db.cursor()
    cursor.execute("select id, link from app_applicationversion")
    data = cursor.fetchall()
    db.close()

    return data


def execute():
    grader_father = os.path.abspath(os.path.dirname(os.getcwd()) + os.path.sep + "..")
    root_dir = grader_father + os.path.sep + "data" + os.path.sep + "app"
    logger.debug("downloader starting!")
    while True:
        data = get_app_list()
        for _id, link in data:
            logger.debug("id: %s, link: %s" % (_id, link))
            filename = link.split("/")[-1]
            dst = root_dir + os.path.sep + filename
            if not os.path.exists(dst):
                http_get(link, dst)
                logger.info("downloader ok: " + dst)
            else:
                logger.info("downloader exists: " + dst)

        time.sleep(5)


def main():
    execute()


if __name__=='__main__':
    main()
