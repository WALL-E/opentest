#!/usr/bin/python3.6

import sys
import os
import time

import MySQLdb
from loguru import logger
from airtest.core.api import *
from airtest.core.error import *

from utils import http_get


config = {
    "HOST": "127.0.0.1",
    "PORT": 5037,
}


def get_device_list():
    db = MySQLdb.connect("127.0.0.1", "root", "123456", "zztest", charset='utf8' )
    cursor = db.cursor()
    cursor.execute("select id, serial from app_device")
    data = cursor.fetchall()
    db.close()

    return data


def execute():
    grader_father = os.path.abspath(os.path.dirname(os.getcwd()) + os.path.sep + "..")
    root_dir = grader_father + os.path.sep + "data" + os.path.sep + "app"
    logger.debug("check_device starting!")
    while True:
        data = get_device_list()
        for id, serial in data:
            logger.debug(id, serial)
            scheme = "android://%s:%s/%s?cap_method=javacap&touch_method=adb" % (
                config["HOST"], 
                config["PORT"], 
                serial
            )
            try:
                connect_device(scheme)
            except DeviceConnectionError as e:
                logger.error(e)

        time.sleep(5)


def main():
    execute()


if __name__=='__main__':
    main()
